// Prisma schema for AlgoStudio
// https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum PlanTier {
  FREE
  PRO
  ELITE
}

enum ExportType {
  MQ5
  MQ4
  EX5
}

enum ExportStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
}

enum EAStatus {
  ONLINE
  OFFLINE
  ERROR
}

// ============================================
// MODELS
// ============================================

model User {
  id              String    @id @default(cuid())
  authProviderId  String    @unique
  email           String    @unique
  passwordHash    String?   // Hashed password (null for OAuth users)
  passwordChangedAt DateTime? // Set on password change/reset for session invalidation
  emailVerified   Boolean   @default(false)
  emailVerifiedAt    DateTime?
  role               String    @default("USER") // USER or ADMIN
  discordId          String?   @unique
  discordAccessToken String?   // Encrypted with AES-256-GCM
  referralCode       String?   @unique
  referredBy      String?   // referralCode of the user who referred them
  lastLoginAt     DateTime?
  adminNotes      String?   @db.Text
  suspended       Boolean   @default(false)
  suspendedAt     DateTime?
  suspendedReason String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  subscription Subscription?
  projects     Project[]
  exports      ExportJob[]
  templates    UserTemplate[]
  liveEAs      LiveEAInstance[]

  @@index([createdAt])
  @@index([suspended])
}

model Subscription {
  id     String   @id @default(cuid())
  userId String   @unique
  tier   PlanTier @default(FREE)
  status String   @default("active")

  // Future-proof Stripe fields
  stripeCustomerId   String?
  stripeSubId        String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  manualPeriodEnd    DateTime?  // Admin-granted extension override

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubId])
}

model Project {
  id          String    @id @default(cuid())
  userId      String
  name        String
  description String?
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relations
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions BuildVersion[]
  exports  ExportJob[]
  tags     ProjectTag[]

  @@index([userId, deletedAt, updatedAt])
  @@index([deletedAt])
}

model ProjectTag {
  id        String @id @default(cuid())
  projectId String
  tag       String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, tag])
  @@index([tag])
}

model BuildVersion {
  id         String   @id @default(cuid())
  projectId  String
  versionNo  Int
  buildJson  Json
  isAutosave Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  exports ExportJob[]

  // Unique constraint: one version number per project
  @@unique([projectId, versionNo])
  @@index([projectId])
  @@index([projectId, isAutosave, versionNo])
}

model ExportJob {
  id             String       @id @default(cuid())
  userId         String
  projectId      String
  buildVersionId String
  exportType     ExportType
  status         ExportStatus @default(QUEUED)
  outputUrl      String?
  outputName     String?
  compileLog     String?      @db.Text
  errorMessage   String?      @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  buildVersion BuildVersion @relation(fields: [buildVersionId], references: [id], onDelete: Cascade)
  liveEA       LiveEAInstance?

  // Indexes for efficient queries
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([projectId, userId, createdAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  eventType    String
  resourceType String?
  resourceId   String?
  metadata     String?  @db.Text
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([createdAt])
}

model WebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique // Stripe event ID
  type        String
  processedAt DateTime @default(now())

  @@index([processedAt])
}

model UserTemplate {
  id        String   @id @default(cuid())
  userId    String
  name      String
  buildJson Json
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model AdminOtp {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model Announcement {
  id          String    @id @default(cuid())
  title       String
  message     String    @db.Text
  type        String    @default("info") // info, warning, maintenance
  active      Boolean   @default(true)
  expiresAt   DateTime?
  scheduledAt DateTime?
  segmentId   String?
  createdBy   String // admin userId
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  segment UserSegment? @relation(fields: [segmentId], references: [id], onDelete: SetNull)

  @@index([active, expiresAt])
  @@index([scheduledAt])
}

// ============================================
// LIVE EA TRACKING
// ============================================

model LiveEAInstance {
  id            String    @id @default(cuid())
  exportJobId   String    @unique
  userId        String
  apiKeyHash    String    @unique
  eaName        String
  symbol        String?
  timeframe     String?
  broker        String?
  accountNumber String?
  status        EAStatus  @default(OFFLINE)
  lastHeartbeat DateTime?
  lastError     String?
  balance       Float?
  equity        Float?
  openTrades    Int       @default(0)
  totalTrades   Int       @default(0)
  totalProfit   Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  exportJob     ExportJob @relation(fields: [exportJobId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  heartbeats    EAHeartbeat[]
  trades        EATrade[]
  errors        EAError[]
  alerts        EAAlert[]

  @@index([userId, status])
  @@index([status, lastHeartbeat])
  @@index([exportJobId])
}

model EAHeartbeat {
  id          String   @id @default(cuid())
  instanceId  String
  balance     Float
  equity      Float
  openTrades  Int
  totalTrades Int
  totalProfit Float
  drawdown    Float    @default(0)
  spread      Int      @default(0)
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, createdAt])
}

model EATrade {
  id          String   @id @default(cuid())
  instanceId  String
  ticket      String
  symbol      String
  type        String
  openPrice   Float
  closePrice  Float?
  lots        Float
  profit      Float    @default(0)
  openTime    DateTime
  closeTime   DateTime?
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, ticket])
  @@index([instanceId, createdAt])
}

model EAError {
  id          String   @id @default(cuid())
  instanceId  String
  errorCode   Int
  message     String   @db.Text
  context     String?
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, createdAt])
}

// ============================================
// ADMIN CONFIGURATION
// ============================================

model PlanLimitConfig {
  id                 String   @id @default(cuid())
  tier               PlanTier @unique
  maxProjects        Int
  maxExportsPerMonth Int
  canExportMQL5      Boolean  @default(true)
  canExportMQL4      Boolean  @default(false)
  updatedAt          DateTime @updatedAt
  updatedBy          String
}

model UserSegment {
  id        String   @id @default(cuid())
  name      String
  filters   String   @db.Text // JSON string of filter criteria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  announcements Announcement[]
}

// ============================================
// REVENUE SNAPSHOTS
// ============================================

model RevenueSnapshot {
  id         String   @id @default(cuid())
  date       DateTime @unique
  mrr        Float
  arr        Float
  paidCount  Int
  freeCount  Int
  proCount   Int
  eliteCount Int
  churnRate  Float
  createdAt  DateTime @default(now())

  @@index([date])
}

// ============================================
// EA ALERT RULES & ALERTS
// ============================================

model EAAlertRule {
  id        String   @id @default(cuid())
  userId    String
  type      String   // DRAWDOWN_EXCEEDED, CONSECUTIVE_LOSSES, OFFLINE_DURATION, EQUITY_DROP
  threshold Float
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  alerts    EAAlert[]

  @@index([enabled, type])
}

model EAAlert {
  id           String         @id @default(cuid())
  ruleId       String
  instanceId   String
  message      String         @db.Text
  acknowledged Boolean        @default(false)
  createdAt    DateTime       @default(now())
  rule         EAAlertRule    @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  instance     LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([acknowledged, createdAt])
}
