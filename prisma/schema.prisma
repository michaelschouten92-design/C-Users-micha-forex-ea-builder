// Prisma schema for AlgoStudio
// https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum PlanTier {
  FREE
  PRO
  ELITE
}

enum ExportType {
  MQ5
  MQ4
  EX5
}

enum ExportStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
}

enum EAStatus {
  ONLINE
  OFFLINE
  ERROR
}

enum EAMode {
  LIVE
  PAPER
}

// ============================================
// MODELS
// ============================================

model User {
  id              String    @id @default(cuid())
  authProviderId  String    @unique
  email           String    @unique
  passwordHash    String?   // Hashed password (null for OAuth users)
  passwordChangedAt DateTime? // Set on password change/reset for session invalidation
  emailVerified   Boolean   @default(false)
  emailVerifiedAt    DateTime?
  role               String    @default("USER") // USER or ADMIN
  discordId          String?   @unique
  discordAccessToken  String?   // Encrypted with AES-256-GCM
  discordRefreshToken String?   // Encrypted with AES-256-GCM
  referralCode       String?   @unique
  referredBy      String?   // referralCode of the user who referred them
  lastLoginAt      DateTime?
  webhookUrl       String?  // User-defined webhook URL for trade notifications
  telegramBotToken String?  // Encrypted Telegram Bot API token
  telegramChatId   String?  // Telegram chat ID for alerts
  leaderboardOptIn Boolean  @default(false)
  adminNotes      String?   @db.Text
  suspended       Boolean   @default(false)
  suspendedAt     DateTime?
  suspendedReason String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  subscription   Subscription?
  projects       Project[]
  exports        ExportJob[]
  templates      UserTemplate[]
  liveEAs        LiveEAInstance[]
  alertRules     EAAlertRule[]
  alertConfigs   EAAlertConfig[]
  backtestResults BacktestResult[]
  templateRatings TemplateRating[]
  tradeJournals  TradeJournal[]

  @@index([createdAt])
  @@index([suspended])
  @@index([referredBy])
}

model Subscription {
  id     String   @id @default(cuid())
  userId String   @unique
  tier   PlanTier @default(FREE)
  status String   @default("active")

  hadPaidPlan Boolean  @default(false) // Set true on first paid subscription, never reset

  // Future-proof Stripe fields
  stripeCustomerId   String?  @unique
  stripeSubId        String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  manualPeriodEnd    DateTime?  // Admin-granted extension override

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubId])
}

model Project {
  id          String    @id @default(cuid())
  userId      String
  name        String
  description String?
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions        BuildVersion[]
  exports         ExportJob[]
  tags            ProjectTag[]
  backtestResults BacktestResult[]
  shares          ProjectShare[]
  tradeJournals   TradeJournal[]

  @@index([userId, deletedAt, updatedAt])
  @@index([deletedAt])
}

model ProjectTag {
  id        String @id @default(cuid())
  projectId String
  tag       String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, tag])
  @@index([tag])
}

model BuildVersion {
  id         String   @id @default(cuid())
  projectId  String
  versionNo  Int
  buildJson  Json
  isAutosave Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  exports ExportJob[]

  // Unique constraint: one version number per project
  @@unique([projectId, versionNo])
  @@index([projectId])
  @@index([projectId, isAutosave, versionNo])
}

model ExportJob {
  id             String       @id @default(cuid())
  userId         String
  projectId      String
  buildVersionId String
  exportType     ExportType
  status         ExportStatus @default(QUEUED)
  outputUrl      String?
  outputName     String?
  compileLog     String?      @db.Text
  errorMessage   String?      @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  buildVersion BuildVersion @relation(fields: [buildVersionId], references: [id], onDelete: Cascade)
  liveEA       LiveEAInstance?

  // Indexes for efficient queries
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([projectId, userId, createdAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  eventType    String
  resourceType String?
  resourceId   String?
  metadata     String?  @db.Text
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([createdAt])
  @@index([resourceType, resourceId, createdAt])
}

model WebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique // Stripe event ID
  type        String
  processedAt DateTime @default(now())

  @@index([processedAt])
}

model UserTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?  @db.Text
  buildJson   Json
  isPublic    Boolean  @default(false)
  downloads   Int      @default(0)
  tags        String[] @default([])
  category    String?
  createdAt   DateTime @default(now())

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ratings TemplateRating[]

  @@index([userId, createdAt])
  @@index([isPublic, createdAt])
  @@index([isPublic, downloads])
  @@index([category])
}

model AdminOtp {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model Announcement {
  id          String    @id @default(cuid())
  title       String
  message     String    @db.Text
  type        String    @default("info") // info, warning, maintenance
  active      Boolean   @default(true)
  expiresAt   DateTime?
  scheduledAt DateTime?
  segmentId   String?
  createdBy   String // admin userId
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  segment UserSegment? @relation(fields: [segmentId], references: [id], onDelete: SetNull)

  @@index([active, expiresAt])
  @@index([scheduledAt])
}

// ============================================
// LIVE EA TRACKING
// ============================================

model LiveEAInstance {
  id            String    @id @default(cuid())
  exportJobId   String    @unique
  userId        String
  apiKeyHash    String    @unique
  eaName        String
  symbol        String?
  timeframe     String?
  broker        String?
  accountNumber String?
  status        EAStatus  @default(OFFLINE)
  mode          EAMode    @default(LIVE)
  paused        Boolean   @default(false)
  lastHeartbeat DateTime?
  lastError     String?
  balance       Float?
  equity        Float?
  openTrades    Int       @default(0)
  totalTrades   Int       @default(0)
  totalProfit   Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  exportJob      ExportJob        @relation(fields: [exportJobId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  heartbeats     EAHeartbeat[]
  trades         EATrade[]
  errors         EAError[]
  alerts         EAAlert[]
  alertConfigs   EAAlertConfig[]
  tradeJournals  TradeJournal[]

  @@index([userId, status])
  @@index([status, lastHeartbeat])
  @@index([exportJobId])
}

model EAHeartbeat {
  id          String   @id @default(cuid())
  instanceId  String
  balance     Float
  equity      Float
  openTrades  Int
  totalTrades Int
  totalProfit Float
  drawdown    Float    @default(0)
  spread      Int      @default(0)
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, createdAt])
}

model EATrade {
  id          String   @id @default(cuid())
  instanceId  String
  ticket      String
  symbol      String
  type        String
  openPrice   Float
  closePrice  Float?
  lots        Float
  profit      Float    @default(0)
  openTime    DateTime
  closeTime   DateTime?
  mode        String?   // "LIVE" | "PAPER"
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, ticket])
  @@index([instanceId, createdAt])
}

model EAError {
  id          String   @id @default(cuid())
  instanceId  String
  errorCode   Int
  message     String   @db.Text
  context     String?
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, createdAt])
}

// ============================================
// ADMIN CONFIGURATION
// ============================================

model PlanLimitConfig {
  id                 String   @id @default(cuid())
  tier               PlanTier @unique
  maxProjects        Int
  maxExportsPerMonth Int
  canExportMQL5      Boolean  @default(true)
  canExportMQL4      Boolean  @default(false)
  updatedAt          DateTime @updatedAt
  updatedBy          String
}

model UserSegment {
  id        String   @id @default(cuid())
  name      String
  filters   String   @db.Text // JSON string of filter criteria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  announcements Announcement[]
}

// ============================================
// REVENUE SNAPSHOTS
// ============================================

model RevenueSnapshot {
  id         String   @id @default(cuid())
  date       DateTime @unique
  mrr        Float
  arr        Float
  paidCount  Int
  freeCount  Int
  proCount   Int
  eliteCount Int
  churnRate  Float
  createdAt  DateTime @default(now())

  @@index([date])
}

// ============================================
// EA ALERT CONFIGURATIONS (user-facing)
// ============================================

model EAAlertConfig {
  id            String          @id @default(cuid())
  userId        String
  instanceId    String?         // null = applies to all instances
  alertType     String          // "DRAWDOWN" | "OFFLINE" | "DAILY_LOSS" | "NEW_TRADE" | "ERROR"
  threshold     Float?          // e.g., 5.0 for 5% drawdown
  channel       String          // "EMAIL" | "WEBHOOK"
  webhookUrl    String?         // for webhook channel
  enabled       Boolean         @default(true)
  lastTriggered DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance LiveEAInstance?  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([userId, enabled])
  @@index([alertType, enabled])
  @@index([instanceId])
}

// ============================================
// EA ALERT RULES & ALERTS
// ============================================

model EAAlertRule {
  id        String   @id @default(cuid())
  userId    String
  type      String   // DRAWDOWN_EXCEEDED, CONSECUTIVE_LOSSES, OFFLINE_DURATION, EQUITY_DROP
  threshold Float
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  alerts    EAAlert[]
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([enabled, type])
}

model EAAlert {
  id           String         @id @default(cuid())
  ruleId       String
  instanceId   String
  message      String         @db.Text
  acknowledged Boolean        @default(false)
  createdAt    DateTime       @default(now())
  rule         EAAlertRule    @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  instance     LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([acknowledged, createdAt])
  @@index([instanceId, acknowledged, createdAt])
  @@index([ruleId])
}

// ============================================
// BACKTEST RESULTS
// ============================================

model BacktestResult {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  results   Json
  fileName  String
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([projectId, createdAt])
}

// ============================================
// TEMPLATE RATINGS
// ============================================

model TemplateRating {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  rating     Int
  review     String?  @db.Text
  createdAt  DateTime @default(now())

  template UserTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
}

// ============================================
// PROJECT SHARING
// ============================================

model ProjectShare {
  id         String    @id @default(cuid())
  projectId  String
  shareToken String    @unique @default(cuid())
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([shareToken])
  @@index([projectId])
}

// ============================================
// TRADE JOURNAL
// ============================================

model TradeJournal {
  id             String          @id @default(cuid())
  userId         String
  projectId      String
  // Backtest reference
  backtestProfit   Float?
  backtestWinRate  Float?
  backtestSharpe   Float?
  // Live reference
  instanceId     String?
  liveProfit     Float?
  liveWinRate    Float?
  liveSharpe     Float?
  // Notes
  notes          String?         @db.Text
  status         String          @default("BACKTESTING") // BACKTESTING, DEMO, LIVE, STOPPED
  startedAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  project  Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  instance LiveEAInstance?  @relation(fields: [instanceId], references: [id])

  @@index([userId, startedAt])
  @@index([projectId])
}
