// Prisma schema for AlgoStudio
// https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum PlanTier {
  FREE
  PRO
  ELITE
}

enum ExportType {
  MQ5
  MQ4
  EX5
}

enum ExportStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
}

// ============================================
// MODELS
// ============================================

model User {
  id              String    @id @default(cuid())
  authProviderId  String    @unique
  email           String    @unique
  passwordHash    String?   // Hashed password (null for OAuth users)
  passwordChangedAt DateTime? // Set on password change/reset for session invalidation
  emailVerified   Boolean   @default(false)
  emailVerifiedAt    DateTime?
  role               String    @default("USER") // USER or ADMIN
  discordId          String?   @unique
  discordAccessToken String?   // Encrypted with AES-256-GCM
  referralCode       String?   @unique
  referredBy      String?   // referralCode of the user who referred them
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  subscription Subscription?
  projects     Project[]
  exports      ExportJob[]
  templates    UserTemplate[]

  @@index([createdAt])
}

model Subscription {
  id     String   @id @default(cuid())
  userId String   @unique
  tier   PlanTier @default(FREE)
  status String   @default("active")

  // Future-proof Stripe fields
  stripeCustomerId   String?
  stripeSubId        String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubId])
}

model Project {
  id          String    @id @default(cuid())
  userId      String
  name        String
  description String?
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relations
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions BuildVersion[]
  exports  ExportJob[]
  tags     ProjectTag[]

  @@index([userId, deletedAt, updatedAt])
  @@index([deletedAt])
}

model ProjectTag {
  id        String @id @default(cuid())
  projectId String
  tag       String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, tag])
  @@index([tag])
}

model BuildVersion {
  id         String   @id @default(cuid())
  projectId  String
  versionNo  Int
  buildJson  Json
  isAutosave Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  exports ExportJob[]

  // Unique constraint: one version number per project
  @@unique([projectId, versionNo])
  @@index([projectId])
  @@index([projectId, isAutosave, versionNo])
}

model ExportJob {
  id             String       @id @default(cuid())
  userId         String
  projectId      String
  buildVersionId String
  exportType     ExportType
  status         ExportStatus @default(QUEUED)
  outputUrl      String?
  outputName     String?
  compileLog     String?      @db.Text
  errorMessage   String?      @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  buildVersion BuildVersion @relation(fields: [buildVersionId], references: [id], onDelete: Cascade)

  // Indexes for efficient queries
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([projectId, userId, createdAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  eventType    String
  resourceType String?
  resourceId   String?
  metadata     String?  @db.Text
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([createdAt])
}

model WebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique // Stripe event ID
  type        String
  processedAt DateTime @default(now())

  @@index([processedAt])
}

model UserTemplate {
  id        String   @id @default(cuid())
  userId    String
  name      String
  buildJson Json
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model AdminOtp {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model Announcement {
  id        String    @id @default(cuid())
  title     String
  message   String    @db.Text
  type      String    @default("info") // info, warning, maintenance
  active    Boolean   @default(true)
  expiresAt DateTime?
  createdBy String // admin userId
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([active, expiresAt])
}
