// Prisma schema for AlgoStudio
// https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum PlanTier {
  FREE
  PRO
  ELITE
}

enum ExportType {
  MQ5
  MQ4
  EX5
}

enum ExportStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
}

enum EAStatus {
  ONLINE
  OFFLINE
  ERROR
}

enum EAMode {
  LIVE
  PAPER
}

enum HealthStatus {
  HEALTHY
  WARNING
  DEGRADED
  INSUFFICIENT_DATA
}

enum BacktestHealthStatus {
  ROBUST
  MODERATE
  WEAK
  INSUFFICIENT_DATA
}

enum UserRole {
  USER
  ADMIN
}

enum SubscriptionStatus {
  active
  trialing
  past_due
  cancelled
  incomplete
  incomplete_expired
  expired
  unpaid
  paused
}

// ============================================
// MODELS
// ============================================

model User {
  id              String    @id @default(cuid())
  authProviderId  String    @unique
  email           String    @unique
  passwordHash    String?   // Hashed password (null for OAuth users)
  passwordChangedAt DateTime? // Set on password change/reset for session invalidation
  emailVerified   Boolean   @default(false)
  emailVerifiedAt    DateTime?
  role               UserRole  @default(USER)
  discordId          String?   @unique
  discordAccessToken  String?   // Encrypted with AES-256-GCM
  discordRefreshToken String?   // Encrypted with AES-256-GCM
  referralCode       String?   @unique
  referredBy      String?   // referralCode of the user who referred them
  lastLoginAt      DateTime?
  webhookUrl       String?  // User-defined webhook URL for trade notifications
  telegramBotToken String?  // Encrypted Telegram Bot API token
  telegramChatId   String?  // Telegram chat ID for alerts
  onboardingDay1SentAt DateTime?
  onboardingDay3SentAt DateTime?
  /// Encrypted with AES-256-GCM
  adminNotes      String?   @db.Text
  suspended       Boolean   @default(false)
  suspendedAt     DateTime?
  suspendedReason String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  subscription   Subscription?
  projects       Project[]
  exports        ExportJob[]
  templates      UserTemplate[]
  liveEAs        LiveEAInstance[]
  alertRules     EAAlertRule[]
  alertConfigs   EAAlertConfig[]
  templateRatings TemplateRating[]
  tradeJournals      TradeJournal[]
  sharedProofBundles SharedProofBundle[]
  backtestUploads    BacktestUpload[]
  pushSubscriptions  PushSubscription[]

  @@index([createdAt])
  @@index([suspended])
  @@index([referredBy])
}

model Subscription {
  id     String   @id @default(cuid())
  userId String   @unique
  tier   PlanTier @default(FREE)
  status SubscriptionStatus @default(active)

  hadPaidPlan Boolean  @default(false) // Set true on first paid subscription, never reset

  // Future-proof Stripe fields
  stripeCustomerId   String?  @unique
  stripeSubId        String?  @unique
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  manualPeriodEnd    DateTime?  // Admin-granted extension override

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
}

model Project {
  id          String    @id @default(cuid())
  userId      String
  name        String
  description String?
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions        BuildVersion[]
  exports         ExportJob[]
  tags            ProjectTag[]
  shares            ProjectShare[]
  tradeJournals     TradeJournal[]
  strategyIdentity  StrategyIdentity?
  backtestUploads   BacktestUpload[]

  @@index([userId, deletedAt, updatedAt])
  @@index([deletedAt])
}

model ProjectTag {
  id        String @id @default(cuid())
  projectId String
  tag       String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, tag])
  @@index([tag])
}

model BuildVersion {
  id         String   @id @default(cuid())
  projectId  String
  versionNo  Int
  buildJson  Json
  isAutosave Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  project           Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  exports           ExportJob[]
  strategyVersions  StrategyVersion[]

  // Unique constraint: one version number per project
  @@unique([projectId, versionNo])
  @@index([projectId])
  @@index([projectId, isAutosave, versionNo])
}

model ExportJob {
  id             String       @id @default(cuid())
  userId         String
  projectId      String
  buildVersionId String
  exportType     ExportType
  status         ExportStatus @default(QUEUED)
  outputUrl      String?
  outputName     String?
  compileLog     String?      @db.Text
  errorMessage   String?      @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?    // Soft delete

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  buildVersion BuildVersion @relation(fields: [buildVersionId], references: [id], onDelete: Cascade)
  liveEA       LiveEAInstance?

  // Indexes for efficient queries
  @@index([userId, createdAt])
  @@index([userId, deletedAt, createdAt])
  @@index([status, createdAt])
  @@index([projectId, userId, createdAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  eventType    String
  resourceType String?
  resourceId   String?
  metadata     String?  @db.Text
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([createdAt])
  @@index([resourceType, resourceId, createdAt])
}

model WebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique // Stripe event ID
  type        String
  processedAt DateTime @default(now())

  @@index([processedAt])
}

model UserTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?  @db.Text
  buildJson   Json
  isPublic    Boolean  @default(false)
  downloads   Int      @default(0)
  tags        String[] @default([])
  category    String?
  createdAt   DateTime @default(now())

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ratings TemplateRating[]

  @@index([userId, createdAt])
  @@index([isPublic, createdAt])
  @@index([isPublic, downloads])
  @@index([category])
}

model AdminOtp {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model Announcement {
  id          String    @id @default(cuid())
  title       String
  message     String    @db.Text
  type        String    @default("info") // info, warning, maintenance
  active      Boolean   @default(true)
  expiresAt   DateTime?
  scheduledAt DateTime?
  segmentId   String?
  createdBy   String // admin userId
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  segment UserSegment? @relation(fields: [segmentId], references: [id], onDelete: SetNull)

  @@index([active, expiresAt])
  @@index([scheduledAt])
}

// ============================================
// LIVE EA TRACKING
// ============================================

model LiveEAInstance {
  id            String    @id @default(cuid())
  exportJobId   String    @unique
  userId        String
  apiKeyHash    String    @unique
  eaName        String
  symbol        String?
  timeframe     String?
  broker        String?
  accountNumber String?
  status        EAStatus  @default(OFFLINE)
  mode          EAMode    @default(LIVE)
  paused        Boolean   @default(false)
  lastHeartbeat DateTime?
  lastError     String?
  balance       Float?
  equity        Float?
  openTrades    Int       @default(0)
  totalTrades   Int       @default(0)
  totalProfit   Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  strategyVersionId String?

  exportJob      ExportJob        @relation(fields: [exportJobId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategyVersion StrategyVersion? @relation(fields: [strategyVersionId], references: [id])
  heartbeats     EAHeartbeat[]
  trades         EATrade[]
  errors         EAError[]
  alerts         EAAlert[]
  alertConfigs   EAAlertConfig[]
  tradeJournals  TradeJournal[]
  trackRecordEvents      TrackRecordEvent[]
  trackRecordCheckpoints TrackRecordCheckpoint[]
  trackRecordState       TrackRecordState?
  ledgerCommitments      LedgerCommitment[]
  healthSnapshots        HealthSnapshot[]
  sharedProofBundles     SharedProofBundle[]

  @@index([userId, status])
  @@index([userId, deletedAt])
  @@index([status, lastHeartbeat])
  @@index([exportJobId])
  @@index([strategyVersionId])
}

model EAHeartbeat {
  id          String   @id @default(cuid())
  instanceId  String
  balance     Float
  equity      Float
  openTrades  Int
  totalTrades Int
  totalProfit Float
  drawdown    Float    @default(0)
  spread      Int      @default(0)
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, createdAt])
}

model EATrade {
  id          String   @id @default(cuid())
  instanceId  String
  ticket      String
  symbol      String
  type        String
  openPrice   Float
  closePrice  Float?
  lots        Float
  profit      Float    @default(0)
  openTime    DateTime
  closeTime   DateTime?
  mode        String?   // "LIVE" | "PAPER"
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, ticket])
  @@index([instanceId, createdAt])
}

model EAError {
  id          String   @id @default(cuid())
  instanceId  String
  errorCode   Int
  message     String   @db.Text
  context     String?
  createdAt   DateTime @default(now())

  instance    LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, createdAt])
}

// ============================================
// ADMIN CONFIGURATION
// ============================================

model PlanLimitConfig {
  id                 String   @id @default(cuid())
  tier               PlanTier @unique
  maxProjects        Int
  maxExportsPerMonth Int
  canExportMQL5      Boolean  @default(true)
  canExportMQL4      Boolean  @default(false)
  updatedAt          DateTime @updatedAt
  updatedBy          String
}

model UserSegment {
  id        String   @id @default(cuid())
  name      String
  filters   String   @db.Text // JSON string of filter criteria
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  announcements Announcement[]
}

// ============================================
// REVENUE SNAPSHOTS
// ============================================

model RevenueSnapshot {
  id         String   @id @default(cuid())
  date       DateTime @unique
  mrr        Float
  arr        Float
  paidCount  Int
  freeCount  Int
  proCount   Int
  eliteCount Int
  churnRate  Float
  createdAt  DateTime @default(now())
}

// ============================================
// EA ALERT CONFIGURATIONS (user-facing)
// ============================================

model EAAlertConfig {
  id            String          @id @default(cuid())
  userId        String
  instanceId    String?         // null = applies to all instances
  alertType     String          // "DRAWDOWN" | "OFFLINE" | "DAILY_LOSS" | "NEW_TRADE" | "ERROR"
  threshold     Float?          // Required for DRAWDOWN and DAILY_LOSS alert types; e.g., 5.0 for 5% drawdown
  channel       String          // "EMAIL" | "WEBHOOK"
  webhookUrl    String?         // for webhook channel
  enabled       Boolean         @default(true)
  lastTriggered DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance LiveEAInstance?  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([userId, instanceId, alertType, channel])
  @@index([userId, enabled])
  @@index([alertType, enabled])
  @@index([instanceId])
}

// ============================================
// EA ALERT RULES & ALERTS (DEPRECATED)
// These models are superseded by EAAlertConfig above.
// Kept for migration compatibility only — do NOT use in new code.
// Runtime code has been removed; see heartbeat/route.ts.
// TODO: Remove these models in a future migration once data is migrated.
// ============================================

model EAAlertRule {
  id        String   @id @default(cuid())
  userId    String
  type      String   // DRAWDOWN_EXCEEDED, CONSECUTIVE_LOSSES, OFFLINE_DURATION, EQUITY_DROP
  threshold Float
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  alerts    EAAlert[]
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([enabled, type])
}

model EAAlert {
  id           String         @id @default(cuid())
  ruleId       String
  instanceId   String
  message      String         @db.Text
  acknowledged Boolean        @default(false)
  createdAt    DateTime       @default(now())
  rule         EAAlertRule    @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  instance     LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([acknowledged, createdAt])
  @@index([instanceId, acknowledged, createdAt])
  @@index([ruleId])
}

// ============================================
// TEMPLATE RATINGS
// ============================================

model TemplateRating {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  rating     Int
  review     String?  @db.Text
  createdAt  DateTime @default(now())

  template UserTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
}

// ============================================
// PROJECT SHARING
// ============================================

model ProjectShare {
  id         String    @id @default(cuid())
  projectId  String
  shareToken String    @unique @default(cuid())
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ============================================
// TRADE JOURNAL
// ============================================

model TradeJournal {
  id             String          @id @default(cuid())
  userId         String
  projectId      String
  // Backtest reference
  backtestProfit   Float?
  backtestWinRate  Float?
  backtestSharpe   Float?
  // Live reference
  instanceId     String?
  liveProfit     Float?
  liveWinRate    Float?
  liveSharpe     Float?
  // Notes & structured review data
  notes          String?         @db.Text
  metadata       Json?           // Structured review fields: entryReason, exitReason, setupQuality, symbol, etc.
  status         String          @default("BACKTESTING") // BACKTESTING, DEMO, LIVE, STOPPED
  startedAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  project  Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  instance LiveEAInstance?  @relation(fields: [instanceId], references: [id], onDelete: SetNull)

  @@index([userId, startedAt])
  @@index([projectId])
}

// ============================================
// TRACK RECORD — Event-Sourced, Tamper-Resistant
// ============================================

model TrackRecordEvent {
  id           String   @id @default(cuid())
  instanceId   String
  seqNo        Int                          // Monotonic sequence per instance
  eventType    String                       // TRADE_OPEN, TRADE_CLOSE, SNAPSHOT, etc.
  eventHash    String                       // SHA-256 of canonical JSON
  prevHash     String                       // Hash of previous event (genesis = "0"×64)
  payload      Json                         // Full event data
  timestamp    DateTime                     // EA-reported time
  receivedAt   DateTime @default(now())     // Server wall clock

  instance     LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, seqNo])             // Enforces monotonic chain per instance
  @@index([instanceId, timestamp])
  @@index([instanceId, eventType, timestamp])
  @@index([eventHash])                      // For chain verification lookups
}

model TrackRecordCheckpoint {
  id              String   @id @default(cuid())
  instanceId      String
  seqNo           Int                       // seqNo of the event this checkpoint covers
  balance         Float
  equity          Float
  highWaterMark   Float
  maxDrawdown     Float
  maxDrawdownPct  Float
  totalTrades     Int
  totalProfit     Float
  totalSwap       Float
  totalCommission Float
  winCount        Int
  lossCount       Int
  hmac            String                    // HMAC-SHA256(state, derived key)
  createdAt       DateTime @default(now())

  instance     LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, seqNo])
  @@index([instanceId, createdAt])
}

model TrackRecordState {
  id              String  @id @default(cuid())
  instanceId      String  @unique            // One state per instance
  lastSeqNo       Int     @default(0)
  lastEventHash   String  @default("0000000000000000000000000000000000000000000000000000000000000000")
  balance         Float   @default(0)
  equity          Float   @default(0)
  highWaterMark   Float   @default(0)
  maxDrawdown     Float   @default(0)
  maxDrawdownPct  Float   @default(0)
  totalTrades     Int     @default(0)
  totalProfit     Float   @default(0)
  totalSwap       Float   @default(0)
  totalCommission Float   @default(0)
  winCount        Int     @default(0)
  lossCount       Int     @default(0)
  openPositions          Json    @default("[]")     // Serialized open position array
  cumulativeCashflow     Float   @default(0)
  maxDrawdownDurationSec Int     @default(0)
  drawdownStartTimestamp Int     @default(0)
  peakEquityTimestamp    Int     @default(0)
  updatedAt              DateTime @updatedAt

  instance        LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
}

model LedgerCommitment {
  id             String   @id @default(cuid())
  instanceId     String
  seqNo          Int                        // seqNo at which this commitment was made
  commitmentHash String                     // SHA-256(instanceId|seqNo|lastEventHash|stateHmac)
  lastEventHash  String                     // Hash of the event at seqNo
  stateHmac      String                     // HMAC of state at this point (from checkpoint)
  /** NULL until submitted to an external notarization provider */
  notarizedAt    DateTime?
  /** Provider name (e.g., "opentimestamps", "originstamp") */
  provider       String?
  /** Opaque proof from the notarization provider */
  proof          String?
  /** Provider verification URL */
  verifyUrl      String?
  createdAt      DateTime @default(now())

  instance       LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, seqNo])
  @@index([instanceId, createdAt])
}

// ============================================
// STRATEGY IDENTITY & HEALTH MONITORING
// ============================================

model StrategyIdentity {
  id                 String   @id @default(cuid())
  projectId          String   @unique
  strategyId         String   @unique  // "AS-" + 8 hex chars, permanent public ID
  currentFingerprint String
  currentVersionId   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  project    Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  versions   StrategyVersion[]
  publicPage VerifiedStrategyPage?

  @@index([strategyId])
}

model StrategyVersion {
  id                 String   @id @default(cuid())
  strategyIdentityId String
  buildVersionId     String
  versionNo          Int
  fingerprint        String   // SHA-256(logicHash + parameterHash + schemaVersion)
  logicHash          String   // SHA-256 of canonical node/edge topology
  parameterHash      String   // SHA-256 of canonical settings + node params
  createdAt          DateTime @default(now())

  strategyIdentity StrategyIdentity  @relation(fields: [strategyIdentityId], references: [id], onDelete: Cascade)
  buildVersion     BuildVersion      @relation(fields: [buildVersionId], references: [id], onDelete: Cascade)
  backtestBaseline BacktestBaseline?
  instances        LiveEAInstance[]

  @@unique([strategyIdentityId, fingerprint])
  @@index([buildVersionId])
}

model BacktestBaseline {
  id                   String   @id @default(cuid())
  strategyVersionId    String   @unique
  backtestResultId     String?
  totalTrades          Int
  winRate              Float
  profitFactor         Float
  maxDrawdownPct       Float
  avgTradesPerDay      Float
  netReturnPct         Float
  sharpeRatio          Float
  volatility           Float?
  initialDeposit       Float
  backtestDurationDays Int
  rawMetrics           Json
  createdAt            DateTime @default(now())

  strategyVersion StrategyVersion @relation(fields: [strategyVersionId], references: [id], onDelete: Cascade)

  @@index([backtestResultId])
}

model HealthSnapshot {
  id                  String       @id @default(cuid())
  instanceId          String
  strategyVersionId   String?
  status              HealthStatus
  overallScore        Float
  returnScore         Float
  volatilityScore     Float
  drawdownScore       Float
  winRateScore        Float
  tradeFrequencyScore Float
  liveReturnPct       Float
  liveVolatility      Float
  liveMaxDrawdownPct  Float
  liveWinRate         Float
  liveTradesPerDay    Float
  baselineReturnPct   Float?
  baselineMaxDDPct    Float?
  baselineWinRate     Float?
  baselineTradesPerDay Float?
  tradesSampled       Int
  windowDays          Int
  // Confidence interval on overallScore (based on sample size)
  confidenceLower     Float    @default(0)
  confidenceUpper     Float    @default(0)
  // CUSUM drift detection
  driftCusumValue     Float    @default(0)
  driftDetected       Boolean  @default(false)
  driftSeverity       Float    @default(0)
  // Primary driver explanation
  primaryDriver       String?
  // Score trend (EWMA-based): "improving" | "stable" | "declining"
  scoreTrend          String?
  // Rolling expectancy (avg PnL per trade as % of balance)
  expectancy          Float?
  createdAt           DateTime @default(now())

  instance LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, createdAt])
  @@index([status])
}

model VerifiedStrategyPage {
  id                 String   @id @default(cuid())
  strategyIdentityId String   @unique
  slug               String   @unique
  isPublic           Boolean  @default(false)
  showEquityCurve    Boolean  @default(true)
  showTradeLog       Boolean  @default(false)
  showHealthStatus   Boolean  @default(true)
  pinnedInstanceId   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  strategyIdentity StrategyIdentity @relation(fields: [strategyIdentityId], references: [id], onDelete: Cascade)

  @@index([slug])
}

// ============================================
// SHARED PROOF BUNDLES
// ============================================

model SharedProofBundle {
  id          String    @id @default(cuid())
  token       String    @unique @default(cuid())
  instanceId  String
  userId      String
  bundleJson  Json
  expiresAt   DateTime?
  accessCount Int       @default(0)
  createdAt   DateTime  @default(now())

  instance LiveEAInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([instanceId])
}

// ============================================
// BACKTEST UPLOAD & ANALYSIS
// ============================================

model BacktestUpload {
  id            String   @id @default(cuid())
  userId        String
  projectId     String?
  contentHash   String                 // SHA-256 dedup (unique per user)
  originalHtml  String   @db.Text      // Full HTML for re-parsing
  fileName      String
  fileSize      Int
  createdAt     DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project  Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  runs     BacktestRun[]

  @@unique([userId, contentHash])
  @@index([userId, createdAt])
  @@index([projectId])
}

model BacktestRun {
  id              String   @id @default(cuid())
  uploadId        String   @unique

  eaName          String?
  symbol          String
  timeframe       String
  period          String
  initialDeposit  Float

  totalNetProfit  Float
  profitFactor    Float
  maxDrawdownPct  Float
  maxDrawdownAbs  Float?
  sharpeRatio     Float?
  recoveryFactor  Float?
  expectedPayoff  Float
  totalTrades     Int
  winRate         Float
  longWinRate     Float?
  shortWinRate    Float?

  healthScore     Int                    // 0-100
  healthStatus    BacktestHealthStatus
  healthScoreVersion Int?               // Algorithm version that produced this score
  confidenceLower    Int?               // Confidence interval lower bound
  confidenceUpper    Int?               // Confidence interval upper bound

  walkForwardResult Json?       // Walk-forward analysis results
  trades          Json         // ParsedDeal[]
  scoreBreakdown  Json?        // Per-metric scores
  parseWarnings    Json?
  detectedLocale   String?
  validationResult Json?        // Monte Carlo validation results

  upload          BacktestUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  aiAnalysis      AIAnalysis?
  createdAt       DateTime       @default(now())

  // NOTE: Financial fields (totalNetProfit, initialDeposit, etc.) use Float (IEEE 754 double precision).
  // For the value ranges in backtest metrics (<$1M, 2 decimal places), precision loss is negligible (~$0.0000001).
  // A full Decimal migration would require touching every consumer. Acceptable trade-off for now.

  @@index([uploadId])
  @@index([createdAt])
}

model AIAnalysis {
  id            String   @id @default(cuid())
  backtestRunId String   @unique
  analysis      String   @db.Text     // AI-generated analysis text
  weaknesses    Json?                 // Structured weakness list
  optimizations Json?                 // AI parameter optimization suggestions
  model         String               // e.g. "claude-sonnet-4-6"
  createdAt     DateTime @default(now())

  backtestRun   BacktestRun @relation(fields: [backtestRunId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

// ============================================
// PUSH NOTIFICATIONS
// ============================================

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
